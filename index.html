<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Song Caddie</title>
  
  <!-- Apple Touch Icon for iOS home screen -->
  <link rel="apple-touch-icon" href="logo-text-small.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  
  <!-- Mobile Web App Settings -->
  <meta name="apple-mobile-web-app-title" content="Song Caddie">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <script src="https://cdn.tailwindcss.com">
</script>
  <style>
    /* Lock screen dimensions */
    html, body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: fixed;
      touch-action: pan-y pan-x;
    }
    
    /* Allow pinch zoom only on lyrics */
    #lyricsContainer {
      touch-action: pinch-zoom;
      margin-top: 20px;
      padding-bottom: 100px;
    }
    
    .chord-pro pre { white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; font-size: 1.125rem; line-height: 1.6; }
    .chord-pro .chord { color: #4f46e5; font-weight: bold; }
    .draggable { cursor: move; user-select: none; }
    .dragging { opacity: 0.5; background: #e5e7eb; }
    body.dark { background-color: #111827; color: #f3f4f6; }
    body.dark .bg-white { background-color: #1f2937; }
    body.dark .bg-gray-50 { background-color: #111827; }
    body.dark .text-gray-500, body.dark .text-gray-600 { color: #9ca3af; }
    body.dark .border-gray-300 { border-color: #4b5563; }
    body.dark .hover\:bg-indigo-50:hover { background-color: #374151; }
    .letter-header { font-weight: bold; font-size: 1.1rem; color: #4f46e5; padding: 0.5rem 1rem; background: #f3f4f6; margin-top: 1rem; }
    body.dark .letter-header { background: #374151; color: #a5b4fc; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
    .view-tab:hover { background-color: #c7d2fe !important; }

    /* Song controls – smaller, more transparent, at very bottom */
    #songNav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      pointer-events: none;
      z-index: 20;
      background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);
    }
    .nav-arrow {
      position: absolute;
      bottom: 16px;
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.25);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      pointer-events: auto;
      transition: all 0.2s;
    }
    .nav-arrow:hover { background: rgba(255,255,255,0.45); transform: scale(1.1); }
    #prevSong { left: 16px; }
    #nextSong { right: 16px; }
    #autoScrollBtn {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.25);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      pointer-events: auto;
      transition: all 0.2s;
    }
    #autoScrollBtn:hover { background: rgba(255,255,255,0.45); transform: translateX(-50%) scale(1.1); }
    #timeDisplay {
      position: fixed;
      top: 12px;
      left: 16px;
      color: rgba(255,255,255,0.5);
      font-size: 12px;
      font-family: system-ui, sans-serif;
      pointer-events: none;
      z-index: 20;
    }
    

  
      /* Bottom sheet (My Songs panel) */

      #sidePanel.bottom-sheet {
        position: fixed;
        left: 50%;
        bottom: 0;
        width: 75vw;
        max-width: 680px;
        height: 75vh;
        background: #fff;
        box-shadow: 0 18px 45px rgba(0,0,0,0.25);
        border-radius: 18px;
        transform: translate(-50%, 100%);
        transition: transform 300ms ease;
        z-index: 20;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        touch-action: none; /* we manage drag */
      }

      #sidePanel.bottom-sheet.open {
        transform: translate(-50%, 0);
      }

      /* The small black grabber line that stays visible */
      #grabberBar {
        position: fixed;
        left: 50%;
        bottom: 10px;
        transform: translateX(-50%);
        width: 54px;
        height: 6px;
        border-radius: 999px;
        background: #000;
        opacity: 0.9;
        z-index: 30;
        cursor: ns-resize;
      }

      /* Larger invisible hit area around the grabber for easy touch */
      #grabberHit {
        position: fixed;
        left: 50%;
        bottom: 0;
        transform: translateX(-50%);
        width: 140px;
        height: 44px;
        z-index: 29;
        background: transparent;
        touch-action: none;
      }


      /* Internal grabber (attached to the panel) */
      #grabberInPanel {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 54px;
        height: 6px;
        border-radius: 999px;
        background: #000;
        opacity: 0.9;
        z-index: 31;
      }
      #grabberInPanelHit {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 180px;
        height: 44px;
        z-index: 30;
        background: transparent;
        touch-action: none;
        cursor: ns-resize;
      }

      /* When open, use the internal grabber; hide the external one */
      #sidePanel.bottom-sheet.open ~ #grabberHit,
      #sidePanel.bottom-sheet.open ~ #grabberBar {
        display: none;
      }

      /* Give content a bit of top room so it doesn't sit under the grabber */
      #sidePanel.bottom-sheet.open .p-3 {
        padding-top: 2.25rem;
      }



      /* Grabber positioning states */
      #grabberBar, #grabberHit { pointer-events: auto; }
      #grabberBar.attached { bottom: auto; }
      #grabberHit.attached { bottom: auto; }


      /* Hide panel footer controls when closed? (keep them inside; panel is hidden anyway) */
      #sidePanel.bottom-sheet:not(.open) .sheet-only-open {
        display: none !important;
      }

      /* Prevent underlying content scroll while dragging on mobile */
      body.sheet-open {
        overflow: hidden;
        touch-action: none;
      }


    
      /* Panel footer buttons (light, aligned) */
      #sidePanel .panel-footer button {
        padding: 8px 12px;
        border-radius: 10px;
        background: #f3f4f6; /* gray-100 */
        color: #111827;      /* gray-900 */
        font-weight: 600;
        font-size: 14px;
      }
      #sidePanel .panel-footer button:hover { background: #e5e7eb; } /* gray-200 */

    </style>
</head>
<body class="bg-gray-50 min-h-screen antialiased">

  <!-- Splash -->
  <div id="splash" class="fixed inset-0 bg-gradient-to-br from-blue-900 to-indigo-950 flex items-center justify-center z-50 transition-opacity duration-800 pointer-events-auto">
    <img src="logo-splash.png" alt="Song Caddie Logo" class="w-80 md:w-[500px] drop-shadow-2xl"/>
  </div>

  <!-- Main -->
  <div id="main" class="hidden relative min-h-screen">

    <!-- Menu button with "All Songs" icon -->
    <button id="menuBtn" class="fixed top-4 right-4 z-30 hover:opacity-80 transition hidden" >
      <svg width="80" height="80" class="block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 140 170" aria-label="All Songs">

  <defs>
    <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="3" stdDeviation="4" flood-opacity="0.18"/>
    </filter>
  </defs>

  <!-- Thinner top two lines (closer to box) -->
  <rect x="58" y="36" width="24" height="3" rx="1.5" fill="#111"/>
  <rect x="48" y="41" width="44" height="3" rx="1.5" fill="#111"/>

  <!-- Rounded square background -->
  <rect x="30" y="46" width="80" height="80" rx="26"
        fill="#111"
        filter="url(#softShadow)"/>

  <!-- Double note (centered + oval + slight CCW tilt) -->
  <g fill="white"
     transform="translate(38,56) scale(3.1,2.6) skewX(-8) rotate(-6 12 10)">
    <path d="M18 2v12.5a2.9 2.9 0 1 1-1.4-2.6V6.1l-6.2 1.5v8.3a2.9 2.9 0 1 1-1.4-2.6V4.8L18 2z"/>
    <path d="M16.4 5.4v-2l-6.6 1.6v2l6.6-1.6z"/>
  </g>

  <!-- Text -->
  <text x="70" y="152"
        text-anchor="middle"
        font-size="24"
        font-weight="600"
        font-family="Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif"
        letter-spacing="0.5"
        fill="#111">
    All Songs
  </text>

</svg>

    </button>

    <main class="p-6 pt-16 max-w-3xl mx-auto relative"> <!-- reduced pt-20 → pt-16 so content starts higher -->
      <div id="noSong" class="text-center py-20 text-gray-500 relative">
        <p class="text-xl mb-8">Select a song from <span class="text-indigo-600 hover:text-indigo-700 cursor-pointer underline" onclick="openPanel()">All Songs</span></p>
        <img src="logo-splash.png" alt="Song Caddie Logo" class="mx-auto w-48 md:w-64 opacity-20"/>
      </div>

      <!-- Song view -->
      <div id="songView" class="hidden bg-white rounded-xl shadow p-6 relative min-h-[calc(100vh-4rem)]">
        <div id="timeDisplay"></div>
        <div id="setlistLabel" class="hidden text-xs text-gray-400 mb-2"></div>
        <h1 id="songTitle" class="text-3xl font-bold mb-1"></h1>
        <p id="songArtist" class="text-gray-600 mb-4"></p>

        <div class="chord-pro overflow-y-auto" id="lyricsContainer">
          <pre id="songLyrics"></pre>
        </div>

        <!-- Controls overlay – fixed at bottom -->
        <div id="songNav">
          <button id="prevSong" class="nav-arrow" >←</button>
          <button id="nextSong" class="nav-arrow" >→</button>
          <button id="autoScrollBtn" >▶</button>
        </div>
      </div>
    </main>

    <!-- Side panel -->
    <div id="sidePanel" class="bottom-sheet">
      <div id="grabberInPanel" aria-hidden="true"></div>
      <div id="grabberInPanelHit" aria-label="Drag to close All Songs panel"></div>
      <div class="p-3 border-b flex items-center gap-3 flex-wrap shrink-0">
        
        <button class="view-tab flex items-center justify-center" data-view="songs" style="padding: 0; background: none; border: none;">
          <img src="My_Songs_Logo_blue.svg" alt="All Songs" class="h-12 w-auto"/>
        </button>
        <button class="view-tab h-9 inline-flex items-center justify-center px-4 rounded-full text-sm font-medium bg-gray-200 text-gray-900 hover:bg-gray-300"" data-view="sets">Setlists</button>
        <button id="addButton" class="h-7 w-7 inline-flex items-center justify-center rounded-full text-white text-lg font-medium" style="background-color: #213C57;">+</button>
      </div>

      <div id="panelContent" class="p-2 flex-1 overflow-hidden flex flex-col"></div>

      <div class="panel-footer p-2 border-t flex items-center justify-between bg-gray-50 relative">
        <button id="editToggleBtn" class="p-2 hover:bg-gray-200 rounded-full" title="Toggle edit mode">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <polyline points="9 11 12 14 15 11"></polyline>
          </svg>
        </button>

        <div class="flex-1 flex justify-center"><div id="editToolbar" class="flex items-center gap-2"></div>

        </div><button id="settingsBtn" class="p-2 hover:bg-gray-200 rounded-full" title="Settings">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
        </button>
      </div>
    </div>

    <div id="backdrop" class="fixed inset-0 bg-black/30 z-10 hidden" onclick="closePanel()"></div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/50">
      <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md">
        <h2 class="text-xl font-bold mb-4">Settings</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Theme</label>
          <select id="themeSelect" class="w-full p-2 border rounded">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Song Font Size</label>
          <select id="fontSizeSelect" class="w-full p-2 border rounded">
            <option value="">Default</option>
            <option value="small">Small</option>
            <option value="large">Large</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 rounded" >Close</button>
        </div>
      </div>
    </div>

    <!-- Confirm Delete -->
    <div id="confirmDeleteModal" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/50">
      <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm text-center">
        <h3 class="text-lg font-bold mb-4">Delete selected item(s)?</h3>
        <p class="text-gray-600 mb-6">This cannot be undone.</p>
        <div class="flex justify-center gap-4">
          <button onclick="document.getElementById('confirmDeleteModal').classList.add('hidden')" class="px-6 py-2 bg-gray-300 rounded" >No</button>
          <button onclick="confirmDelete()" class="px-6 py-2 bg-red-600 text-white rounded" >Yes</button>
        </div>
      </div>
    </div>

    <!-- Add Song Modal -->
    <div id="addSongModal" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/50">
      <div class="bg-white p-5 rounded-lg shadow-xl w-11/12 max-w-md">
        <h2 class="text-lg font-bold mb-3">Add New Song</h2>
        <input id="addTitle" type="text" placeholder="Title" class="w-full p-2 border rounded mb-2 text-sm">
        <input id="addArtist" type="text" placeholder="Artist" class="w-full p-2 border rounded mb-2 text-sm">
        <textarea id="addLyrics" placeholder="Lyrics with chords..." class="w-full p-2 border rounded mb-3 h-28 text-sm"></textarea>
        <div class="flex justify-end gap-2">
          <button onclick="document.getElementById('addSongModal').classList.add('hidden')" class="px-3 py-1.5 bg-gray-300 rounded text-sm" >Cancel</button>
          <button onclick="saveNewSong()" class="px-3 py-1.5 bg-indigo-600 text-white rounded text-sm" >Save</button>
        </div>
      </div>
    </div>

    <!-- Edit Song Modal -->
    <div id="editSongModal" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/50">
      <div class="bg-white p-5 rounded-lg shadow-xl w-11/12 max-w-md">
        <h2 class="text-lg font-bold mb-3">Edit Song</h2>
        <input id="editTitle" type="text" placeholder="Title" class="w-full p-2 border rounded mb-2 text-sm">
        <input id="editArtist" type="text" placeholder="Artist" class="w-full p-2 border rounded mb-2 text-sm">
        <textarea id="editLyrics" placeholder="Lyrics with chords..." class="w-full p-2 border rounded mb-3 h-28 text-sm"></textarea>
        <div class="flex justify-end gap-2">
          <button onclick="document.getElementById('editSongModal').classList.add('hidden')" class="px-3 py-1.5 bg-gray-300 rounded text-sm" >Cancel</button>
          <button onclick="saveEditedSong()" class="px-3 py-1.5 bg-indigo-600 text-white rounded text-sm" >Save</button>
        </div>
      </div>
    </div>

    <!-- Add Set Modal -->
    <div id="addSetModal" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/50">
      <div class="bg-white p-5 rounded-lg shadow-xl w-11/12 max-w-md">
        <h2 class="text-lg font-bold mb-3">New Set</h2>
        <input id="addSetName" type="text" placeholder="Set Name" class="w-full p-2 border rounded mb-3 text-sm">
        <div class="flex justify-end gap-2">
          <button onclick="document.getElementById('addSetModal').classList.add('hidden')" class="px-3 py-1.5 bg-gray-300 rounded text-sm" >Cancel</button>
          <button onclick="saveNewSet()" class="px-3 py-1.5 bg-indigo-600 text-white rounded text-sm" >Create</button>
        </div>
      </div>
    </div>

    <script>
      let songs = JSON.parse(localStorage.getItem('songCaddieSongs')) || [];
      let setlists = JSON.parse(localStorage.getItem('songCaddieSetlists')) || [];
      let currentView = 'songs';
      let currentSort = 'date';
      let selectedSetlist = null;
      let editMode = false;
      let selectedIds = new Set();
      let currentArtistFilter = null;
      let renamingSetId = null;
      let lastListState = null;
      let currentSong = null;
      let currentEditSongId = null;

      let currentSongIndex = -1;
      let currentSongList = [];
      let autoScrollInterval = null;
      let isScrolling = false;


      // --- Chord rendering (highlights [Em] style chords safely) ---
      function escapeHtml(s) {
        return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      }

      function renderChordMarkup(text) {
        const safe = escapeHtml(text || '');
        // [Em] [G] => <span class="chord">[Em]</span>
        return safe.replace(/\[([^\]\n]{1,12})\]/g, (_, chord) => `<span class="chord">[${chord}]</span>`);
      }


      function saveData() {
        localStorage.setItem('songCaddieSongs', JSON.stringify(songs));
        localStorage.setItem('songCaddieSetlists', JSON.stringify(setlists));
      }

      function openPanel() {
        const panel = document.getElementById('sidePanel');
        panel.classList.add('open');
        document.body.classList.add('sheet-open');
        document.getElementById('backdrop').classList.remove('hidden');
        document.getElementById('menuBtn').classList.add('hidden');
        renderPanelContent();
      }

      function closePanel() {
        const panel = document.getElementById('sidePanel');
        panel.classList.remove('open');
        panel.style.transform = '';
        document.body.classList.remove('sheet-open');
        document.getElementById('backdrop').classList.add('hidden');
        document.getElementById('menuBtn').classList.remove('hidden');
        editMode = false;
        selectedIds.clear();
        currentArtistFilter = null;
        renamingSetId = null;
        renderPanelContent();
      }

      document.getElementById('backdrop').onclick = closePanel;

      let touchStartX = 0;
      document.addEventListener('touchstart', e => touchStartX = e.touches[0].clientX);
      document.addEventListener('touchmove', e => {
        if (touchStartX - e.touches[0].clientX > 70) closePanel();
      });

      // Splash
      setTimeout(() => {
        const splash = document.getElementById('splash');
        splash.style.opacity = '0';
        setTimeout(() => {
          splash.style.display = 'none';
          document.getElementById('main').classList.remove('hidden');
          document.getElementById('menuBtn').classList.remove('hidden');
          renderPanelContent();
        }, 800);
      }, 1200);

      document.getElementById('splash').addEventListener('click', () => {
        const splash = document.getElementById('splash');
        splash.style.opacity = '0';
        setTimeout(() => {
          splash.style.display = 'none';
          document.getElementById('main').classList.remove('hidden');
          document.getElementById('menuBtn').classList.remove('hidden');
          renderPanelContent();
        }, 800);
      });

      // Menu button
      document.getElementById('menuBtn').onclick = () => {
        if (!document.getElementById('songView').classList.contains('hidden')) {
          // Currently viewing a song - open panel and return to last list state
          if (lastListState) {
            currentView = lastListState.view;
            selectedSetlist = lastListState.selectedSetlist || null;
            currentArtistFilter = lastListState.currentArtistFilter || null;
            currentSort = lastListState.currentSort || 'date';
          } else {
            currentView = 'songs';
            selectedSetlist = null;
            currentArtistFilter = null;
            currentSort = 'date';
          }

          // Update tab styling
          document.querySelectorAll('.view-tab').forEach(t => {
            if (t.dataset.view === 'songs') {
              // Handle SVG button - use opacity
              t.style.opacity = t.dataset.view === currentView ? '1' : '0.5';
            } else {
              // Handle regular button
              if (t.dataset.view === currentView) {
                t.classList.add('bg-indigo-600', 'text-white');
                t.classList.remove('bg-gray-200', 'text-gray-900');
              } else {
                t.classList.remove('bg-indigo-600', 'text-white');
                t.classList.add('bg-gray-200', 'text-gray-900');
              }
            }
          });

          renderPanelContent();
          openPanel();
        } else {
          openPanel();
        }
      };

      document.querySelectorAll('.view-tab').forEach(tab => {
        tab.onclick = () => {
          currentView = tab.dataset.view;
          selectedSetlist = null;
          currentArtistFilter = null;
          renamingSetId = null;
          lastListState = null;
          document.querySelectorAll('.view-tab').forEach(t => {
            // Handle SVG button (Songs) - adjust opacity
            if (t.dataset.view === 'songs') {
              t.style.opacity = t === tab ? '1' : '0.5';
            } else {
              // Handle regular button (Setlists) - use background colors
              t.classList.remove('bg-indigo-600', 'text-white');
              t.classList.add('bg-gray-200', 'text-gray-900');
            }
          });
          // Highlight selected tab
          if (tab.dataset.view !== 'songs') {
            tab.classList.add('bg-indigo-600', 'text-white');
            tab.classList.remove('bg-gray-200', 'text-gray-900');
          }
          renderPanelContent();
        };
      });

      // Add button handler - opens song or set modal based on current view
      document.getElementById('addButton').onclick = () => {
        if (currentView === 'songs') {
          document.getElementById('addSongModal').classList.remove('hidden');
        } else if (currentView === 'sets') {
          document.getElementById('addSetModal').classList.remove('hidden');
        }
      };

      document.getElementById('editToggleBtn').onclick = () => {
        editMode = !editMode;
        selectedIds.clear();
        renamingSetId = null;
        const btn = document.getElementById('editToggleBtn');
        btn.innerHTML = editMode ?
          `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>` :
          `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><polyline points="9 11 12 14 15 11"></polyline></svg>`;
        renderPanelContent();
      };

      document.getElementById('settingsBtn').onclick = () => document.getElementById('settingsModal').classList.remove('hidden');

      document.getElementById('themeSelect').onchange = e => {
        document.body.classList.toggle('dark', e.target.value === 'dark');
        localStorage.setItem('theme', e.target.value);
      };

      document.getElementById('fontSizeSelect').onchange = e => {
        document.body.classList.remove('font-small', 'font-large');
        if (e.target.value) document.body.classList.add('font-' + e.target.value);
        localStorage.setItem('fontSize', e.target.value);
      };

      const theme = localStorage.getItem('theme') || 'light';
      document.getElementById('themeSelect').value = theme;
      document.body.classList.toggle('dark', theme === 'dark');

      const font = localStorage.getItem('fontSize') || '';
      document.getElementById('fontSizeSelect').value = font;
      if (font) document.body.classList.add('font-' + font);

      // Time display
      function updateTime() {
        const now = new Date();
        document.getElementById('timeDisplay').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      }
      setInterval(updateTime, 1000);
      updateTime();

      // Autoscroll
      function toggleAutoScroll() {
        const btn = document.getElementById('autoScrollBtn');
        if (isScrolling) {
          clearInterval(autoScrollInterval);
          isScrolling = false;
          btn.innerHTML = '▶';
        } else {
          const container = document.getElementById('lyricsContainer');
          autoScrollInterval = setInterval(() => {
            container.scrollBy(0, 1.2); // speed – increase 1.2 for faster
          }, 100);
          isScrolling = true;
          btn.innerHTML = '⏸';
        }
      }
      document.getElementById('autoScrollBtn').onclick = toggleAutoScroll;

      // Prev / Next
      function goPrevSong() {
        if (currentSongIndex > 0) {
          currentSongIndex--;
          showSong(currentSongList[currentSongIndex]);
        }
      }

      function goNextSong() {
        if (currentSongIndex < currentSongList.length - 1) {
          currentSongIndex++;
          showSong(currentSongList[currentSongIndex]);
        }
      }

      document.getElementById('prevSong').onclick = goPrevSong;
      document.getElementById('nextSong').onclick = goNextSong;

      // Swipe detection on song view
      let touchStartXSong = 0;
      document.getElementById('songView').addEventListener('touchstart', e => {
        touchStartXSong = e.touches[0].clientX;
      });
      document.getElementById('songView').addEventListener('touchend', e => {
        const touchEndX = e.changedTouches[0].clientX;
        const diff = touchStartXSong - touchEndX;
        if (Math.abs(diff) > 60) {
          if (diff > 0) goNextSong();
          else goPrevSong();
        }
      });

      function showSong(song) {
        currentSong = song;
        lastListState = {
          view: currentView,
          selectedSetlist: selectedSetlist,
          currentArtistFilter: currentArtistFilter,
          currentSort: currentSort
        };

        let allSongs = songs;
        if (currentView === 'sets' && selectedSetlist) {
          const set = setlists.find(s => s.id === selectedSetlist);
          if (set) allSongs = set.songIds.map(id => songs.find(s => s.id === id)).filter(Boolean);
        } else if (currentArtistFilter) {
          allSongs = songs.filter(s => s.artist === currentArtistFilter);
        }

        const searchVal = document.querySelector('#songs-search')?.value?.toLowerCase() || '';
        if (searchVal) allSongs = allSongs.filter(s => s.title.toLowerCase().includes(searchVal));

        currentSongList = allSongs;
        currentSongIndex = currentSongList.findIndex(s => s.id === song.id);

        document.getElementById('noSong').classList.add('hidden');
        document.getElementById('songView').classList.remove('hidden');
        document.getElementById('songTitle').textContent = song.title;
        document.getElementById('songArtist').textContent = '— ' + song.artist;
        document.getElementById('songLyrics').innerHTML = renderChordMarkup(song.lyricsWithChords || '');
        
        // Display setlist name if viewing from a setlist
        const setlistLabel = document.getElementById('setlistLabel');
        if (currentView === 'sets' && selectedSetlist) {
          const set = setlists.find(s => s.id === selectedSetlist);
          if (set) {
            setlistLabel.textContent = set.name;
            setlistLabel.classList.remove('hidden');
          }
        } else {
          setlistLabel.classList.add('hidden');
        }

        document.getElementById('lyricsContainer').scrollTop = 0;
        if (isScrolling) toggleAutoScroll();

        closePanel();
      }

      function getSearchPlaceholder() {
        if (currentArtistFilter) return `Search songs by ${currentArtistFilter}…`;
        if (currentSort === 'artist') return 'Search artists...';
        return 'Search songs...';
      }

      function renderPanelContent() {
        const content = document.getElementById('panelContent');
        if (!content) return;
        content.innerHTML = '';

        if (currentView === 'songs') {
          const searchDiv = document.createElement('div');
          searchDiv.className = 'mb-2 relative';
          const searchId = 'songs-search';
          searchDiv.innerHTML = `
            <label for="${searchId}" class="sr-only">Search</label>
            <input id="${searchId}" type="search" placeholder="${getSearchPlaceholder()}" class="w-full px-3 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400">
          `;
          content.appendChild(searchDiv);
        }

        const toolbar = document.getElementById('editToolbar');
        toolbar.innerHTML = '';
        if (editMode && selectedIds.size > 0) {
          toolbar.innerHTML = `
            ${currentView === 'songs' ? '<button class="h-9 px-3 inline-flex items-center justify-center rounded-full bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700" onclick="showAddToSetModal()">+ Set</button>' : ''}
            <button class="p-1.5 hover:bg-gray-200 rounded-full" onclick="showDeleteConfirm()" title="Delete selected">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="red" stroke-width="2">
                <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14z"/>
              </svg>
            </button>
          `;
        }

        if (currentView === 'songs') {
          if (!currentArtistFilter) {
            const sortDiv = document.createElement('div');
            sortDiv.className = 'mb-2 flex items-center gap-2 text-sm';
            sortDiv.innerHTML = `
              <label>Sort:</label>
              <select id="sortSelect" class="p-1.5 border rounded text-sm">
                <option value="date">Date added</option>
                <option value="title">Title</option>
                <option value="artist">Artist</option>
              </select>
            `;
            const sel = sortDiv.querySelector('#sortSelect');
            sel.value = currentSort;
            sel.onchange = () => {
              currentSort = sel.value;
              currentArtistFilter = null;
              renderPanelContent();
            };
            content.appendChild(sortDiv);
          }

          const list = document.createElement('div');
          list.id = 'songList';
          list.className = 'flex-1 overflow-y-auto divide-y divide-gray-200';
          content.appendChild(list);

          const searchInput = document.querySelector('#songs-search');
          if (currentSort === 'artist' && !currentArtistFilter) {
            renderArtistList(list, searchInput ? searchInput.value : '');
          } else {
            renderSongsList(searchInput ? searchInput.value : '', list);
          }

          // Attach search handler after rendering
          if (searchInput) {
            searchInput.oninput = () => {
              const list = document.getElementById('songList');
              if (currentSort === 'artist' && !currentArtistFilter) {
                renderArtistList(list, searchInput.value);
              } else {
                renderSongsList(searchInput.value, list);
              }
            };
          }
        } else if (currentView === 'sets') {
          if (selectedSetlist) {
            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex items-center justify-between mb-3';
            
            const backBtn = document.createElement('button');
            backBtn.textContent = '← Back to Sets';
            backBtn.className = 'text-sm text-indigo-600 hover:underline';
            backBtn.onclick = () => {
              selectedSetlist = null;
              renderPanelContent();
            };
            headerDiv.appendChild(backBtn);
            
            
            
            content.appendChild(headerDiv);

            const setNameHeader = document.createElement('h3');
            setNameHeader.className = 'text-xl font-bold mb-4 px-2';
            const set = setlists.find(s => s.id === selectedSetlist);
            setNameHeader.textContent = set ? set.name : 'Set';
            content.appendChild(setNameHeader);

            const songList = document.createElement('div');
            songList.id = 'setSongList';
            songList.className = 'flex-1 overflow-y-auto divide-y divide-gray-200';
            content.appendChild(songList);

            if (!set || set.songIds.length === 0) {
              songList.innerHTML = '<p class="text-center py-10 text-gray-500">No songs in this set yet.</p>';
            } else {
              set.songIds.forEach(songId => {
                const song = songs.find(s => s.id === songId);
                if (song) addSongRow(song, songList);
              });
              
              // Add drag-and-drop functionality when in edit mode (bind once)
              if (editMode && !songList.dataset.dndBound) {
                songList.dataset.dndBound = '1';
                songList.addEventListener('dragstart', e => {
                  const item = e.target.closest('[draggable]');
                  if (item) item.classList.add('dragging');
                });
                songList.addEventListener('dragend', e => {
                  const item = e.target.closest('[draggable]');
                  if (item) item.classList.remove('dragging');
                });
                songList.addEventListener('dragover', e => {
                  e.preventDefault();
                  const dragging = songList.querySelector('.dragging');
                  if (!dragging) return;
                  const after = [...songList.children].find(el => 
                    el !== dragging && 
                    e.clientY < el.getBoundingClientRect().top + el.getBoundingClientRect().height / 2
                  );
                  if (after) songList.insertBefore(dragging, after);
                  else songList.appendChild(dragging);
                });
                songList.addEventListener('drop', () => {
                  const newOrder = [...songList.children].map(el => el.dataset.songId).filter(Boolean);
                  set.songIds = newOrder;
                  saveData();
                  renderPanelContent();
                });
              }
            }
          } else {
            const list = document.createElement('div');
            list.id = 'setList';
            list.className = 'flex-1 overflow-y-auto divide-y divide-gray-200 text-sm';
            content.appendChild(list);

            if (setlists.length === 0) {
              list.innerHTML = '<p class="text-center py-10 text-gray-500">No sets yet. Click + to create one.</p>';
            } else {
              setlists.forEach(s => {
                const row = document.createElement('div');
                row.className = 'flex items-center px-4 py-2 hover:bg-indigo-50 border-b text-sm relative';
                row.draggable = editMode;
                row.dataset.id = s.id;

                if (renamingSetId === s.id) {
                  row.innerHTML = `
                    <input type="text" value="${s.name}" class="flex-1 p-1 border rounded text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400" autofocus onblur="finishRenameSet('${s.id}', this.value)" onkeydown="if(event.key==='Enter') finishRenameSet('${s.id}', this.value); if(event.key==='Escape') finishRenameSet('${s.id}', null);">
                    ${editMode ? `
                      <button class="ml-2 p-1 hover:bg-gray-200 rounded-full drag-handle" title="Drag to reorder">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="8" y1="6" x2="16" y2="6"></line>
                          <line x1="8" y1="12" x2="16" y2="12"></line>
                          <line x1="8" y1="18" x2="16" y2="18"></line>
                        </svg>
                      </button>
                    ` : ''}
                  `;
                } else {
                  row.innerHTML = `
                    ${editMode ? `<input type="checkbox" class="mr-3 set-checkbox" data-id="${s.id}" ${selectedIds.has(s.id) ? 'checked' : ''}>` : ''}
                    <div class="flex-1 cursor-pointer" ${editMode ? `onclick="startRenameSet('${s.id}')"` : `onclick="selectedSetlist = '${s.id}'; renderPanelContent();"`}>
                      <div class="font-medium truncate">${s.name}</div>
                    </div>
                    ${editMode ? `
                      <button class="ml-2 p-1 hover:bg-gray-200 rounded-full drag-handle" title="Drag to reorder">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="8" y1="6" x2="16" y2="6"></line>
                          <line x1="8" y1="12" x2="16" y2="12"></line>
                          <line x1="8" y1="18" x2="16" y2="18"></line>
                        </svg>
                      </button>
                    ` : ''}
                  `;
                }

                list.appendChild(row);
              });
            }

            if (editMode) {
              list.querySelectorAll('.set-checkbox').forEach(chk => {
                chk.onchange = e => {
                  if (e.target.checked) selectedIds.add(e.target.dataset.id);
                  else selectedIds.delete(e.target.dataset.id);
                  renderPanelContent();
                };
              });

              // Add drag-and-drop functionality when in edit mode (bind once)

              if (editMode && !list.dataset.dndBound) {

                list.dataset.dndBound = '1';

                list.addEventListener('dragstart', e => {
                const item = e.target.closest('[draggable]');
                if (item) item.classList.add('dragging');
              });
              list.addEventListener('dragend', e => {
                const item = e.target.closest('[draggable]');
                if (item) item.classList.remove('dragging');
              });
              list.addEventListener('dragover', e => {
                e.preventDefault();
                const dragging = list.querySelector('.dragging');
                const after = [...list.children].find(el => el !== dragging && e.clientY < el.getBoundingClientRect().top + el.getBoundingClientRect().height / 2);
                if (after) list.insertBefore(dragging, after);
                else list.appendChild(dragging);
              });
              list.addEventListener('drop', () => {
                const newOrder = [...list.children].map(el => el.dataset.id).filter(Boolean);
                setlists = newOrder.map(id => setlists.find(s => s.id === id)).filter(Boolean);
                saveData();
                renderPanelContent();
              });

              }
            }
          }
        }
      }

      function startRenameSet(id) {
        renamingSetId = id;
        renderPanelContent();
      }

      function finishRenameSet(id, newName) {
        if (newName !== null && newName.trim()) {
          const set = setlists.find(s => s.id === id);
          if (set) {
            set.name = newName.trim();
            saveData();
          }
        }
        renamingSetId = null;
        renderPanelContent();
      }

      function renderArtistList(container, filter = '') {
        let artists = [...new Set(songs.map(s => s.artist))];
        if (filter.trim()) {
          const lower = filter.toLowerCase();
          artists = artists.filter(a => a.toLowerCase().includes(lower));
        }
        artists.sort((a, b) => a.localeCompare(b));

        container.innerHTML = '';

        artists.forEach(artist => {
          const count = songs.filter(s => s.artist === artist).length;
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between px-4 py-3 hover:bg-indigo-50 border-b cursor-pointer';
          row.innerHTML = `
            <div class="font-medium">${artist}</div>
            <div class="text-sm text-gray-500">${count} song${count !== 1 ? 's' : ''}</div>
          `;
          row.onclick = () => {
            currentArtistFilter = artist;
            renderPanelContent();
          };
          container.appendChild(row);
        });
      }

      function renderSongsList(filter = '', container) {
        container.innerHTML = '';

        let filtered = songs;
        if (currentArtistFilter) {
          filtered = filtered.filter(s => s.artist === currentArtistFilter);
        }

        if (filter.trim()) {
          const lower = filter.toLowerCase();
          filtered = filtered.filter(s => s.title.toLowerCase().includes(lower));
        }

        if (currentArtistFilter) {
          if (!container.parentElement.querySelector('.artist-header')) {
            const header = document.createElement('div');
            header.className = 'artist-header text-2xl font-bold mb-4 px-4';
            header.textContent = currentArtistFilter;
            container.parentElement.insertBefore(header, container);
          }

          if (!container.parentElement.querySelector('.back-btn')) {
            const back = document.createElement('button');
            back.textContent = '← Back to Artists';
            back.className = 'back-btn mb-3 ml-4 text-sm text-indigo-600 hover:underline';
            back.onclick = () => {
              currentArtistFilter = null;
              renderPanelContent();
            };
            container.parentElement.insertBefore(back, container);
          }
        }

        const useAlphabet = currentSort === 'title' && !currentArtistFilter;

        if (useAlphabet) {
          let lastLetter = '';
          filtered.forEach(song => {
            const firstLetter = song.title.charAt(0).toUpperCase();
            if (firstLetter !== lastLetter) {
              const header = document.createElement('div');
              header.className = 'letter-header';
              header.textContent = firstLetter;
              container.appendChild(header);
              lastLetter = firstLetter;
            }
            addSongRow(song, container);
          });
        } else {
          filtered.forEach(song => addSongRow(song, container));
        }
      }

      function addSongRow(song, container) {
        const row = document.createElement('div');
        const isCurrentSong = currentSong && currentSong.id === song.id;
        row.className = `flex items-center px-4 py-2 hover:bg-indigo-50 border-b text-sm relative ${isCurrentSong ? 'bg-indigo-100' : ''}`;
        
        // Make draggable only in edit mode and when in a set view
        const inSetView = currentView === 'sets' && selectedSetlist;
        if (editMode && inSetView) {
          row.draggable = true;
          row.dataset.songId = song.id;
        }

        let dateLabel = 'No date';
        if (song.dateAdded) {
          const date = new Date(song.dateAdded);
          const today = new Date();
          today.setHours(0,0,0,0);
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          const weekAgo = new Date(today);
          weekAgo.setDate(weekAgo.getDate() - 7);

          if (date.toDateString() === today.toDateString()) dateLabel = 'Today';
          else if (date.toDateString() === yesterday.toDateString()) dateLabel = 'Yesterday';
          else if (date >= weekAgo && date < today) dateLabel = 'This week';
          else dateLabel = date.toLocaleDateString('default', { month: 'short', year: 'numeric' });
        }

        // Only show date if NOT in a set view
        const extra = inSetView ? '' : `<div class="text-xs text-gray-500 ml-auto">${dateLabel}</div>`;

        row.innerHTML = `
          ${editMode ? `<input type="checkbox" class="mr-3" ${selectedIds.has(song.id)?'checked':''}>` : ''}
          <div class="flex-1 min-w-0">
            <div class="font-medium truncate">${song.title}</div>
            ${currentArtistFilter ? '' : `<div class="text-xs text-gray-600 truncate">${song.artist}</div>`}
          </div>
          ${extra}
          ${editMode ? `
            <button class="ml-2 p-1 hover:bg-gray-200 rounded-full edit-song-btn" data-id="${song.id}" title="Edit song">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </button>
          ` : ''}
          ${editMode && inSetView ? `
            <button class="ml-2 p-1 hover:bg-gray-200 rounded-full drag-handle" title="Drag to reorder">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="8" y1="6" x2="16" y2="6"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
                <line x1="8" y1="18" x2="16" y2="18"></line>
              </svg>
            </button>
          ` : ''}
        `;

        if (editMode) {
          row.querySelector('input').onchange = e => {
            if (e.target.checked) selectedIds.add(song.id);
            else selectedIds.delete(song.id);
            renderPanelContent();
          };
          row.querySelector('.edit-song-btn')?.addEventListener('click', e => {
            e.stopPropagation();
            editSong(song.id);
          });
        } else {
          row.onclick = () => showSong(song);
        }

        container.appendChild(row);
        
        // Scroll current song into view when panel is opened
        if (isCurrentSong) {
          setTimeout(() => {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 100);
        }
      }

      function editSong(id) {
        const song = songs.find(s => s.id === id);
        if (!song) return;
        currentEditSongId = id;
        document.getElementById('editTitle').value = song.title;
        document.getElementById('editArtist').value = song.artist;
        document.getElementById('editLyrics').value = song.lyricsWithChords || '';
        document.getElementById('editSongModal').classList.remove('hidden');
      }

      function saveEditedSong() {
        const title = document.getElementById('editTitle').value.trim();
        const artist = document.getElementById('editArtist').value.trim();
        const lyrics = document.getElementById('editLyrics').value.trim();
        if (title && artist && lyrics && currentEditSongId) {
          const song = songs.find(s => s.id === currentEditSongId);
          if (song) {
            song.title = title;
            song.artist = artist;
            song.lyricsWithChords = lyrics;
            saveData();
            renderPanelContent();
            document.getElementById('editSongModal').classList.add('hidden');
          }
        }
      }

      function showDeleteConfirm() {
        document.getElementById('confirmDeleteModal').classList.remove('hidden');
      }

      function confirmDelete() {
        document.getElementById('confirmDeleteModal').classList.add('hidden');
        if (currentView === 'songs') {
          songs = songs.filter(s => !selectedIds.has(s.id));
          setlists.forEach(s => s.songIds = s.songIds.filter(id => !selectedIds.has(id)));
        } else if (currentView === 'sets') {
          setlists = setlists.filter(s => !selectedIds.has(s.id));
        }
        saveData();
        selectedIds.clear();
        editMode = false;
        renderPanelContent();
      }

      function showAddToSetModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white p-6 rounded-lg w-11/12 max-w-sm max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4">Add to Set</h3>
            ${setlists.length === 0 ? '<p class="text-center text-gray-500 mb-4">No sets yet. Create one first.</p>' : ''}
            ${setlists.map(s => `
              <button class="w-full text-left px-4 py-3 hover:bg-indigo-50 border-b last:border-b-0" onclick="addSelectedToSet('${s.id}'); this.closest('.fixed').remove()">
                ${s.name} (${s.songIds.length} songs)
              </button>
            `).join('')}
            <button class="mt-4 w-full py-2 bg-gray-300 rounded text-sm" onclick="this.closest('.fixed').remove()">Cancel</button>
          </div>
        `;
        document.body.appendChild(modal);
      }

      function addSelectedToSet(setId) {
        const set = setlists.find(s => s.id === setId);
        if (!set) return;

        selectedIds.forEach(id => {
          if (!set.songIds.includes(id)) {
            set.songIds.push(id);
          }
        });

        saveData();
        renderPanelContent();
      }

      function showAddSongsToSetModal() {
        const set = setlists.find(s => s.id === selectedSetlist);
        if (!set) return;
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
        modal.id = 'addSongsToSetModal';
        
        const selectedSongIds = new Set();
        
        function renderSongList(searchTerm = '') {
          const filteredSongs = songs.filter(song => 
            song.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
            song.artist.toLowerCase().includes(searchTerm.toLowerCase())
          );
          
          return filteredSongs.map(song => `
            <label class="flex items-center px-4 py-3 hover:bg-indigo-50 border-b cursor-pointer">
              <input type="checkbox" class="mr-3 song-checkbox" data-id="${song.id}" ${selectedSongIds.has(song.id) || set.songIds.includes(song.id) ? 'checked' : ''} ${set.songIds.includes(song.id) ? 'disabled' : ''}>
              <div class="flex-1 min-w-0">
                <div class="font-medium truncate">${song.title}</div>
                <div class="text-xs text-gray-600 truncate">${song.artist}</div>
              </div>
              ${set.songIds.includes(song.id) ? '<span class="text-xs text-gray-500">Already in set</span>' : ''}
            </label>
          `).join('');
        }
        
        modal.innerHTML = `
          <div class="bg-white rounded-lg w-11/12 max-w-md max-h-[80vh] flex flex-col">
            <div class="p-4 border-b">
              <h3 class="text-lg font-bold mb-3">Add Songs to ${set.name}</h3>
              <input type="text" id="addSongsSearch" placeholder="Search songs..." class="w-full p-2 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400">
            </div>
            <div class="flex-1 overflow-y-auto" id="songSelectionList">
              ${renderSongList()}
            </div>
            <div class="p-4 border-t flex gap-2">
              <button class="flex-1 py-2 bg-gray-300 rounded text-sm hover:bg-gray-400" onclick="this.closest('.fixed').remove()">Cancel</button>
              <button id="confirmAddSongs" class="flex-1 py-2 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700" >Add Songs</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Handle search
        const searchInput = modal.querySelector('#addSongsSearch');
        searchInput.oninput = (e) => {
          const listContainer = modal.querySelector('#songSelectionList');
          listContainer.innerHTML = renderSongList(e.target.value);
          
          // Re-attach checkbox listeners
          listContainer.querySelectorAll('.song-checkbox:not([disabled])').forEach(checkbox => {
            checkbox.onchange = (e) => {
              if (e.target.checked) {
                selectedSongIds.add(e.target.dataset.id);
              } else {
                selectedSongIds.delete(e.target.dataset.id);
              }
            };
          });
        };
        
        // Handle checkbox changes
        modal.querySelectorAll('.song-checkbox:not([disabled])').forEach(checkbox => {
          checkbox.onchange = (e) => {
            if (e.target.checked) {
              selectedSongIds.add(e.target.dataset.id);
            } else {
              selectedSongIds.delete(e.target.dataset.id);
            }
          };
        });
        
        // Handle confirm button
        modal.querySelector('#confirmAddSongs').onclick = () => {
          selectedSongIds.forEach(songId => {
            if (!set.songIds.includes(songId)) {
              set.songIds.push(songId);
            }
          });
          saveData();
          renderPanelContent();
          modal.remove();
        };
      }

      function saveNewSong() {
        const title = document.getElementById('addTitle').value.trim();
        const artist = document.getElementById('addArtist').value.trim();
        const lyrics = document.getElementById('addLyrics').value.trim();
        if (title && artist && lyrics) {
          songs.push({
            id: Date.now().toString(),
            title, artist, lyricsWithChords: lyrics,
            dateAdded: new Date().toISOString()
          });
          saveData();
          renderPanelContent();
          document.getElementById('addSongModal').classList.add('hidden');
        }
      }

      function saveNewSet() {
        const name = document.getElementById('addSetName').value.trim();
        if (name) {
          setlists.push({ id: Date.now().toString(), name, songIds: [] });
          saveData();
          renderPanelContent();
          document.getElementById('addSetModal').classList.add('hidden');
        }
      }

      if (songs.length === 0) {
        songs = [
          { id: '1', title: 'Wonderwall', artist: 'Oasis', lyricsWithChords: '[Em] [G] [D] [A7sus4]\nToday is gonna be the day...', dateAdded: new Date().toISOString() },
          { id: '2', title: 'Horse With No Name', artist: 'America', lyricsWithChords: '[Em] [D6/9] ...\nOn the first part...', dateAdded: new Date().toISOString() },
          { id: '3', title: 'Hallelujah', artist: 'Leonard Cohen', lyricsWithChords: '[C] [Am] ...\nI\'ve heard there was...', dateAdded: new Date().toISOString() }
        ];
        saveData();
      }

      // Handle orientation changes - lock screen dimensions
      window.addEventListener('orientationchange', () => {
        setTimeout(() => {
          window.scrollTo(0, 0);
          document.body.style.height = window.innerHeight + 'px';
        }, 100);
      });

      // Lock initial height
      document.body.style.height = window.innerHeight + 'px';

      // Enable pinch-to-zoom on lyrics only
      let lyricsScale = 1;
      let lastDistance = 0;
      
      const lyricsContainer = document.getElementById('lyricsContainer');
      const lyricsElement = document.getElementById('songLyrics');
      
      lyricsContainer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          lastDistance = Math.hypot(
            e.touches[0].pageX - e.touches[1].pageX,
            e.touches[0].pageY - e.touches[1].pageY
          );
        }
      });
      
      lyricsContainer.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const distance = Math.hypot(
            e.touches[0].pageX - e.touches[1].pageX,
            e.touches[0].pageY - e.touches[1].pageY
          );
          
          if (lastDistance > 0) {
            const delta = distance - lastDistance;
            lyricsScale = Math.max(0.5, Math.min(3, lyricsScale + delta * 0.01));
            lyricsElement.style.fontSize = (lyricsScale * 1.125) + 'rem';
          }
          
          lastDistance = distance;
        }
      });
      
      lyricsContainer.addEventListener('touchend', () => {
        lastDistance = 0;
      });

      renderPanelContent();

      // Safety: ensure menu button is visible after initial render
      document.getElementById('menuBtn')?.classList.remove('hidden');

    </script>

    <!-- Bottom sheet grabber (always visible) -->
    <div id="grabberHit" aria-label="Open All Songs panel"></div>
    <div id="grabberBar" aria-hidden="true"></div>
  
    <script>
      // Bottom sheet interactions:
      // - Desktop: click to open/close (no drag)
      // - Touch devices (iPhone/iPad): drag to open/close + tap to toggle

      document.addEventListener('DOMContentLoaded', () => {
        const panel = document.getElementById('sidePanel');
        const hitClosed = document.getElementById('grabberHit');
        const barClosed = document.getElementById('grabberBar');
        const hitOpen = document.getElementById('grabberInPanelHit');
        const addSongFooterBtn = document.getElementById('addSongFooterBtn');

        if (!panel || !hitClosed || !barClosed || !hitOpen) return;

        // Footer add song button
        addSongFooterBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          if (typeof showAddSongModal === 'function') showAddSongModal();
        });

        const backdrop = document.getElementById('backdrop');
        const menuBtn = document.getElementById('menuBtn');

        const isTouchDevice =
          window.matchMedia?.('(pointer: coarse)').matches ||
          'ontouchstart' in window ||
          (navigator.maxTouchPoints || 0) > 0;

        let dragging = false;
        let startY = 0;
        let startPxDown = 0; // 0=open, panelHeight=closed
        let panelHeight = 0;

        function computeMetrics() {
          panelHeight = panel.getBoundingClientRect().height;
        }

        function setTranslate(pxDown) {
          panel.style.transform = `translate(-50%, ${pxDown}px)`;
        }

        function openSheet() {
          panel.classList.add('open');
          panel.classList.remove('dragging');
          panel.style.transform = '';
          document.body.classList.add('sheet-open');
          backdrop?.classList.remove('hidden');
          menuBtn?.classList.add('hidden');
          if (typeof renderPanelContent === 'function') renderPanelContent();
        }

        function closeSheet() {
          panel.classList.remove('open');
          panel.classList.remove('dragging');
          panel.style.transform = '';
          document.body.classList.remove('sheet-open');
          backdrop?.classList.add('hidden');
          menuBtn?.classList.remove('hidden');

          // reset edit state (matches your existing closePanel behavior)
          try {
            editMode = false;
            selectedIds?.clear?.();
            currentArtistFilter = null;
            renamingSetId = null;
          } catch {}
          if (typeof renderPanelContent === 'function') renderPanelContent();
        }

        function toggle(e) {
          e?.preventDefault?.();
          if (dragging) return;
          if (panel.classList.contains('open')) closeSheet();
          else openSheet();
        }

        // Always allow click toggle (desktop + mobile)
        hitClosed.addEventListener('click', toggle);
        barClosed.addEventListener('click', toggle);

        // If not touch, STOP here: desktop is click-only.
        if (!isTouchDevice) return;

        // Touch drag support
        function getY(e) {
          return (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
        }

        function startDrag(y) {
          dragging = true;
          computeMetrics();
          startY = y;
          startPxDown = panel.classList.contains('open') ? 0 : panelHeight;
          panel.classList.add('dragging');
          setTranslate(startPxDown);
        }

        function moveDrag(y) {
          if (!dragging) return;
          const dy = y - startY;
          let next = startPxDown + dy;
          if (next < 0) next = 0;
          if (next > panelHeight) next = panelHeight;
          setTranslate(next);
        }

        function endDrag() {
          if (!dragging) return;
          dragging = false;
          panel.classList.remove('dragging');
          computeMetrics();

          const mm = panel.style.transform.match(/,\s*([-\d.]+)px\)/);
          const pxDown = mm ? parseFloat(mm[1]) : (panel.classList.contains('open') ? 0 : panelHeight);

          if (pxDown > panelHeight * 0.55) closeSheet();
          else openSheet();
        }

        function bindTouchDrag(el) {
          el.addEventListener('touchstart', (e) => {
            startDrag(getY(e));
            e.preventDefault();
          }, { passive: false });

          el.addEventListener('touchmove', (e) => {
            moveDrag(getY(e));
            e.preventDefault();
          }, { passive: false });

          el.addEventListener('touchend', (e) => {
            endDrag();
            e.preventDefault();
          });

          el.addEventListener('touchcancel', (e) => {
            endDrag();
            e.preventDefault();
          });
        }

        // Drag from:
        // - bottom grabber (closed state)
        // - top grabber hit area (open state)
        [hitClosed, barClosed, hitOpen].forEach(bindTouchDrag);

        window.addEventListener('resize', () => {
          panel.style.transform = '';
          panel.classList.remove('dragging');
        });
      });
    </script>

  </body>
</html>