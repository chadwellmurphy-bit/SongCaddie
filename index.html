<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Song Caddie</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .chord-pro pre { white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; font-size: 1.125rem; line-height: 1.6; }
    .chord-pro .chord { color: #4f46e5; font-weight: bold; }
    .draggable { cursor: move; user-select: none; }
    .dragging { opacity: 0.5; background: #e5e7eb; }
    body.dark { background-color: #111827; color: #f3f4f6; }
    body.dark .bg-white { background-color: #1f2937; }
    body.dark .bg-gray-50 { background-color: #111827; }
    body.dark .text-gray-500, body.dark .text-gray-600 { color: #9ca3af; }
    body.dark .border-gray-300 { border-color: #4b5563; }
    body.dark .hover\:bg-indigo-50:hover { background-color: #374151; }
    .letter-header { font-weight: bold; font-size: 1.1rem; color: #4f46e5; padding: 0.5rem 1rem; background: #f3f4f6; margin-top: 1rem; }
    body.dark .letter-header { background: #374151; color: #a5b4fc; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

    /* Song controls – smaller, more transparent, at very bottom */
    #songNav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      pointer-events: none;
      z-index: 20;
      background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);
    }
    .nav-arrow {
      position: absolute;
      bottom: 16px;
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.25);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      pointer-events: auto;
      transition: all 0.2s;
    }
    .nav-arrow:hover { background: rgba(255,255,255,0.45); transform: scale(1.1); }
    #prevSong { left: 16px; }
    #nextSong { right: 16px; }
    #autoScrollBtn {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.25);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      pointer-events: auto;
      transition: all 0.2s;
    }
    #autoScrollBtn:hover { background: rgba(255,255,255,0.45); transform: translateX(-50%) scale(1.1); }
    #timeDisplay {
      position: fixed;
      top: 12px;
      left: 16px;
      color: rgba(255,255,255,0.5);
      font-size: 12px;
      font-family: system-ui, sans-serif;
      pointer-events: none;
      z-index: 20;
    }
    #lyricsContainer {
      margin-top: 20px; /* reduced top margin → lyrics higher */
      padding-bottom: 100px; /* space for bottom controls */
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen antialiased">

  <!-- Splash -->
  <div id="splash" class="fixed inset-0 bg-gradient-to-br from-blue-900 to-indigo-950 flex items-center justify-center z-50 transition-opacity duration-800 pointer-events-auto">
    <img src="logo-splash.png" alt="Song Caddie Logo" class="w-80 md:w-[500px] drop-shadow-2xl"/>
  </div>

  <!-- Main -->
  <div id="main" class="hidden relative min-h-screen">

    <!-- Hamburger menu – hidden when panel open -->
    <button id="menuBtn" class="fixed top-4 right-4 z-30 text-gray-800 hover:text-indigo-600 transition hidden">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>

    <main class="p-6 pt-16 max-w-3xl mx-auto relative"> <!-- reduced pt-20 → pt-16 so content starts higher -->
      <div id="noSong" class="text-center py-20 text-gray-500">
        <p class="text-xl mb-8">Select a song from the menu →</p>
        <img src="logo-splash.png" alt="Song Caddie Logo" class="mx-auto w-48 md:w-64 opacity-80"/>
      </div>

      <!-- Song view -->
      <div id="songView" class="hidden bg-white rounded-xl shadow p-6 relative min-h-[calc(100vh-4rem)]">
        <div id="timeDisplay"></div>

        <h1 id="songTitle" class="text-3xl font-bold mb-1"></h1>
        <p id="songArtist" class="text-gray-600 mb-4"></p>

        <div class="chord-pro overflow-y-auto" id="lyricsContainer">
          <pre id="songLyrics"></pre>
        </div>

        <!-- Controls overlay – fixed at bottom -->
        <div id="songNav">
          <button id="prevSong" class="nav-arrow">←</button>
          <button id="nextSong" class="nav-arrow">→</button>
          <button id="autoScrollBtn">▶</button>
        </div>
      </div>
    </main>

    <!-- Side panel -->
    <div id="sidePanel" class="fixed inset-y-0 right-0 w-[66%] max-w-sm bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-20 flex flex-col">
      <div class="p-3 border-b flex items-center gap-3 flex-wrap shrink-0">
        <img src="logo-text-small.png" alt="Song Caddie Text Logo" class="h-9 md:h-10"/>
        <button class="view-tab px-3 py-1 rounded-full text-xs md:text-sm font-medium bg-indigo-600 text-white" data-view="songs">Songs</button>
        <button class="view-tab px-3 py-1 rounded-full text-xs md:text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300" data-view="sets">Sets</button>
      </div>

      <div id="panelContent" class="p-2 flex-1 overflow-hidden flex flex-col"></div>

      <div class="p-2 border-t flex justify-between items-center shrink-0 bg-gray-50 relative">
        <button id="editToggleBtn" class="p-2 hover:bg-gray-200 rounded-full" title="Toggle edit mode">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <polyline points="9 11 12 14 15 11"></polyline>
          </svg>
        </button>

        <div id="editToolbar" class="flex gap-4"></div>

        <button id="settingsBtn" class="p-2 hover:bg-gray-200 rounded-full" title="Settings">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
        </button>
      </div>
    </div>

    <div id="backdrop" class="fixed inset-0 bg-black/30 z-10 hidden" onclick="closePanel()"></div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/50">
      <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md">
        <h2 class="text-xl font-bold mb-4">Settings</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Theme</label>
          <select id="themeSelect" class="w-full p-2 border rounded">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">Song Font Size</label>
          <select id="fontSizeSelect" class="w-full p-2 border rounded">
            <option value="">Default</option>
            <option value="small">Small</option>
            <option value="large">Large</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 rounded">Close</button>
        </div>
      </div>
    </div>

    <!-- Confirm Delete -->
    <div id="confirmDeleteModal" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/50">
      <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm text-center">
        <h3 class="text-lg font-bold mb-4">Delete selected item(s)?</h3>
        <p class="text-gray-600 mb-6">This cannot be undone.</p>
        <div class="flex justify-center gap-4">
          <button onclick="document.getElementById('confirmDeleteModal').classList.add('hidden')" class="px-6 py-2 bg-gray-300 rounded">No</button>
          <button onclick="confirmDelete()" class="px-6 py-2 bg-red-600 text-white rounded">Yes</button>
        </div>
      </div>
    </div>

    <!-- Add Song Modal -->
    <div id="addSongModal" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/50">
      <div class="bg-white p-5 rounded-lg shadow-xl w-11/12 max-w-md">
        <h2 class="text-lg font-bold mb-3">Add New Song</h2>
        <input id="addTitle" type="text" placeholder="Title" class="w-full p-2 border rounded mb-2 text-sm">
        <input id="addArtist" type="text" placeholder="Artist" class="w-full p-2 border rounded mb-2 text-sm">
        <textarea id="addLyrics" placeholder="Lyrics with chords..." class="w-full p-2 border rounded mb-3 h-28 text-sm"></textarea>
        <div class="flex justify-end gap-2">
          <button onclick="document.getElementById('addSongModal').classList.add('hidden')" class="px-3 py-1.5 bg-gray-300 rounded text-sm">Cancel</button>
          <button onclick="saveNewSong()" class="px-3 py-1.5 bg-indigo-600 text-white rounded text-sm">Save</button>
        </div>
      </div>
    </div>

    <!-- Edit Song Modal -->
    <div id="editSongModal" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/50">
      <div class="bg-white p-5 rounded-lg shadow-xl w-11/12 max-w-md">
        <h2 class="text-lg font-bold mb-3">Edit Song</h2>
        <input id="editTitle" type="text" placeholder="Title" class="w-full p-2 border rounded mb-2 text-sm">
        <input id="editArtist" type="text" placeholder="Artist" class="w-full p-2 border rounded mb-2 text-sm">
        <textarea id="editLyrics" placeholder="Lyrics with chords..." class="w-full p-2 border rounded mb-3 h-28 text-sm"></textarea>
        <div class="flex justify-end gap-2">
          <button onclick="document.getElementById('editSongModal').classList.add('hidden')" class="px-3 py-1.5 bg-gray-300 rounded text-sm">Cancel</button>
          <button onclick="saveEditedSong()" class="px-3 py-1.5 bg-indigo-600 text-white rounded text-sm">Save</button>
        </div>
      </div>
    </div>

    <!-- Add Set Modal -->
    <div id="addSetModal" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black/50">
      <div class="bg-white p-5 rounded-lg shadow-xl w-11/12 max-w-md">
        <h2 class="text-lg font-bold mb-3">New Set</h2>
        <input id="addSetName" type="text" placeholder="Set Name" class="w-full p-2 border rounded mb-3 text-sm">
        <div class="flex justify-end gap-2">
          <button onclick="document.getElementById('addSetModal').classList.add('hidden')" class="px-3 py-1.5 bg-gray-300 rounded text-sm">Cancel</button>
          <button onclick="saveNewSet()" class="px-3 py-1.5 bg-indigo-600 text-white rounded text-sm">Create</button>
        </div>
      </div>
    </div>

    <script>
      let songs = JSON.parse(localStorage.getItem('songCaddieSongs')) || [];
      let setlists = JSON.parse(localStorage.getItem('songCaddieSetlists')) || [];
      let currentView = 'songs';
      let currentSort = 'date';
      let selectedSetlist = null;
      let editMode = false;
      let selectedIds = new Set();
      let currentArtistFilter = null;
      let renamingSetId = null;
      let lastListState = null;

      let currentSongIndex = -1;
      let currentSongList = [];
      let autoScrollInterval = null;
      let isScrolling = false;

      function saveData() {
        localStorage.setItem('songCaddieSongs', JSON.stringify(songs));
        localStorage.setItem('songCaddieSetlists', JSON.stringify(setlists));
      }

      function openPanel() {
        document.getElementById('sidePanel').classList.remove('translate-x-full');
        document.getElementById('backdrop').classList.remove('hidden');
        document.getElementById('menuBtn').classList.add('hidden');
        renderPanelContent();
      }

      function closePanel() {
        document.getElementById('sidePanel').classList.add('translate-x-full');
        document.getElementById('backdrop').classList.add('hidden');
        document.getElementById('menuBtn').classList.remove('hidden');
        editMode = false;
        selectedIds.clear();
        currentArtistFilter = null;
        renamingSetId = null;
        renderPanelContent();
      }

      document.getElementById('backdrop').onclick = closePanel;

      let touchStartX = 0;
      document.addEventListener('touchstart', e => touchStartX = e.touches[0].clientX);
      document.addEventListener('touchmove', e => {
        if (touchStartX - e.touches[0].clientX > 70) closePanel();
      });

      // Splash
      setTimeout(() => {
        const splash = document.getElementById('splash');
        splash.style.opacity = '0';
        setTimeout(() => {
          splash.style.display = 'none';
          document.getElementById('main').classList.remove('hidden');
          document.getElementById('menuBtn').classList.remove('hidden');
          renderPanelContent();
        }, 800);
      }, 1200);

      document.getElementById('splash').addEventListener('click', () => {
        const splash = document.getElementById('splash');
        splash.style.opacity = '0';
        setTimeout(() => {
          splash.style.display = 'none';
          document.getElementById('main').classList.remove('hidden');
          document.getElementById('menuBtn').classList.remove('hidden');
          renderPanelContent();
        }, 800);
      });

      // Menu button
      document.getElementById('menuBtn').onclick = () => {
        if (!document.getElementById('songView').classList.contains('hidden')) {
          document.getElementById('songView').classList.add('hidden');
          document.getElementById('noSong').classList.remove('hidden');

          if (lastListState) {
            currentView = lastListState.view;
            selectedSetlist = lastListState.selectedSetlist || null;
            currentArtistFilter = lastListState.currentArtistFilter || null;
            currentSort = lastListState.currentSort || 'date';
          } else {
            currentView = 'songs';
            selectedSetlist = null;
            currentArtistFilter = null;
            currentSort = 'date';
          }

          renderPanelContent();
          openPanel();
        } else {
          openPanel();
        }
      };

      document.querySelectorAll('.view-tab').forEach(tab => {
        tab.onclick = () => {
          currentView = tab.dataset.view;
          selectedSetlist = null;
          currentArtistFilter = null;
          renamingSetId = null;
          lastListState = null;
          document.querySelectorAll('.view-tab').forEach(t => {
            t.classList.remove('bg-indigo-600', 'text-white');
            t.classList.add('bg-gray-200', 'text-gray-700');
          });
          tab.classList.add('bg-indigo-600', 'text-white');
          tab.classList.remove('bg-gray-200', 'text-gray-700');
          renderPanelContent();
        };
      });

      document.getElementById('editToggleBtn').onclick = () => {
        editMode = !editMode;
        selectedIds.clear();
        renamingSetId = null;
        const btn = document.getElementById('editToggleBtn');
        btn.innerHTML = editMode ?
          `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>` :
          `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><polyline points="9 11 12 14 15 11"></polyline></svg>`;
        renderPanelContent();
      };

      document.getElementById('settingsBtn').onclick = () => document.getElementById('settingsModal').classList.remove('hidden');

      document.getElementById('themeSelect').onchange = e => {
        document.body.classList.toggle('dark', e.target.value === 'dark');
        localStorage.setItem('theme', e.target.value);
      };

      document.getElementById('fontSizeSelect').onchange = e => {
        document.body.classList.remove('font-small', 'font-large');
        if (e.target.value) document.body.classList.add('font-' + e.target.value);
        localStorage.setItem('fontSize', e.target.value);
      };

      const theme = localStorage.getItem('theme') || 'light';
      document.getElementById('themeSelect').value = theme;
      document.body.classList.toggle('dark', theme === 'dark');

      const font = localStorage.getItem('fontSize') || '';
      document.getElementById('fontSizeSelect').value = font;
      if (font) document.body.classList.add('font-' + font);

      // Time display
      function updateTime() {
        const now = new Date();
        document.getElementById('timeDisplay').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      }
      setInterval(updateTime, 1000);
      updateTime();

      // Autoscroll
      function toggleAutoScroll() {
        const btn = document.getElementById('autoScrollBtn');
        if (isScrolling) {
          clearInterval(autoScrollInterval);
          isScrolling = false;
          btn.innerHTML = '▶';
        } else {
          const container = document.getElementById('lyricsContainer');
          autoScrollInterval = setInterval(() => {
            container.scrollBy(0, 1.2); // speed – increase 1.2 for faster
          }, 100);
          isScrolling = true;
          btn.innerHTML = '⏸';
        }
      }
      document.getElementById('autoScrollBtn').onclick = toggleAutoScroll;

      // Prev / Next
      function goPrevSong() {
        if (currentSongIndex > 0) {
          currentSongIndex--;
          showSong(currentSongList[currentSongIndex]);
        }
      }

      function goNextSong() {
        if (currentSongIndex < currentSongList.length - 1) {
          currentSongIndex++;
          showSong(currentSongList[currentSongIndex]);
        }
      }

      document.getElementById('prevSong').onclick = goPrevSong;
      document.getElementById('nextSong').onclick = goNextSong;

      // Swipe detection on song view
      let touchStartXSong = 0;
      document.getElementById('songView').addEventListener('touchstart', e => {
        touchStartXSong = e.touches[0].clientX;
      });
      document.getElementById('songView').addEventListener('touchend', e => {
        const touchEndX = e.changedTouches[0].clientX;
        const diff = touchStartXSong - touchEndX;
        if (Math.abs(diff) > 60) {
          if (diff > 0) goNextSong();
          else goPrevSong();
        }
      });

      function showSong(song) {
        lastListState = {
          view: currentView,
          selectedSetlist: selectedSetlist,
          currentArtistFilter: currentArtistFilter,
          currentSort: currentSort
        };

        let allSongs = songs;
        if (currentView === 'sets' && selectedSetlist) {
          const set = setlists.find(s => s.id === selectedSetlist);
          if (set) allSongs = set.songIds.map(id => songs.find(s => s.id === id)).filter(Boolean);
        } else if (currentArtistFilter) {
          allSongs = songs.filter(s => s.artist === currentArtistFilter);
        }

        const searchVal = document.querySelector('#songs-search')?.value?.toLowerCase() || '';
        if (searchVal) allSongs = allSongs.filter(s => s.title.toLowerCase().includes(searchVal));

        currentSongList = allSongs;
        currentSongIndex = currentSongList.findIndex(s => s.id === song.id);

        document.getElementById('noSong').classList.add('hidden');
        document.getElementById('songView').classList.remove('hidden');
        document.getElementById('songTitle').textContent = song.title;
        document.getElementById('songArtist').textContent = '— ' + song.artist;
        document.getElementById('songLyrics').textContent = song.lyricsWithChords || '';

        document.getElementById('lyricsContainer').scrollTop = 0;
        if (isScrolling) toggleAutoScroll();

        closePanel();
      }

      function getSearchPlaceholder() {
        if (currentArtistFilter) return `Search songs by ${currentArtistFilter}…`;
        if (currentSort === 'artist') return 'Search artists...';
        return 'Search songs...';
      }

      function renderPanelContent() {
        const content = document.getElementById('panelContent');
        if (!content) return;
        content.innerHTML = '';

        if (currentView === 'songs') {
          const searchDiv = document.createElement('div');
          searchDiv.className = 'mb-2 relative';
          const searchId = 'songs-search';
          searchDiv.innerHTML = `
            <label for="${searchId}" class="sr-only">Search</label>
            <input id="${searchId}" type="search" placeholder="${getSearchPlaceholder()}" class="w-full px-3 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400">
          `;
          content.appendChild(searchDiv);
          const searchInput = searchDiv.querySelector('input');
        }

        const toolbar = document.getElementById('editToolbar');
        toolbar.innerHTML = '';
        if (editMode && selectedIds.size > 0) {
          toolbar.innerHTML = `
            ${currentView === 'songs' ? '<button class="px-4 py-1.5 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700" onclick="showAddToSetModal()">+Set</button>' : ''}
            <button class="p-1.5 hover:bg-gray-200 rounded-full" onclick="showDeleteConfirm()" title="Delete selected">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="red" stroke-width="2">
                <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14z"/>
              </svg>
            </button>
          `;
        }

        if (currentView === 'songs') {
          if (!currentArtistFilter) {
            const sortDiv = document.createElement('div');
            sortDiv.className = 'mb-2 flex items-center gap-2 text-sm';
            sortDiv.innerHTML = `
              <label>Sort:</label>
              <select id="sortSelect" class="p-1.5 border rounded text-sm">
                <option value="date">Date added</option>
                <option value="title">Title</option>
                <option value="artist">Artist</option>
              </select>
            `;
            const sel = sortDiv.querySelector('#sortSelect');
            sel.value = currentSort;
            sel.onchange = () => {
              currentSort = sel.value;
              currentArtistFilter = null;
              renderPanelContent();
            };
            content.appendChild(sortDiv);
          }

          const addBtn = document.createElement('button');
          addBtn.textContent = '+';
          addBtn.className = 'absolute top-3 right-3 px-2.5 py-1 bg-indigo-600 text-white rounded-full text-sm';
          addBtn.onclick = () => document.getElementById('addSongModal').classList.remove('hidden');
          content.appendChild(addBtn);

          const list = document.createElement('div');
          list.id = 'songList';
          list.className = 'flex-1 overflow-y-auto divide-y divide-gray-200';
          content.appendChild(list);

          const searchInput = document.querySelector('#songs-search');
          if (currentSort === 'artist' && !currentArtistFilter) {
            renderArtistList(list, searchInput ? searchInput.value : '');
          } else {
            renderSongsList(searchInput ? searchInput.value : '', list);
          }

          if (searchInput) {
            searchInput.oninput = () => renderPanelContent();
          }
        } else if (currentView === 'sets') {
          if (selectedSetlist) {
            const backBtn = document.createElement('button');
            backBtn.textContent = '← Back to Sets';
            backBtn.className = 'mb-3 text-sm text-indigo-600 hover:underline';
            backBtn.onclick = () => {
              selectedSetlist = null;
              renderPanelContent();
            };
            content.appendChild(backBtn);

            const setNameHeader = document.createElement('h3');
            setNameHeader.className = 'text-xl font-bold mb-4 px-2';
            const set = setlists.find(s => s.id === selectedSetlist);
            setNameHeader.textContent = set ? set.name : 'Set';
            content.appendChild(setNameHeader);

            const songList = document.createElement('div');
            songList.className = 'flex-1 overflow-y-auto divide-y divide-gray-200';
            content.appendChild(songList);

            if (!set || set.songIds.length === 0) {
              songList.innerHTML = '<p class="text-center py-10 text-gray-500">No songs in this set yet.</p>';
            } else {
              set.songIds.forEach(songId => {
                const song = songs.find(s => s.id === songId);
                if (song) addSongRow(song, songList);
              });
            }
          } else {
            const list = document.createElement('div');
            list.id = 'setList';
            list.className = 'flex-1 overflow-y-auto divide-y divide-gray-200 text-sm';
            content.appendChild(list);

            if (setlists.length === 0) {
              list.innerHTML = '<p class="text-center py-10 text-gray-500">No sets yet. Click + to create one.</p>';
            } else {
              setlists.forEach(s => {
                const row = document.createElement('div');
                row.className = 'flex items-center px-4 py-2 hover:bg-indigo-50 border-b text-sm relative';
                row.draggable = editMode;
                row.dataset.id = s.id;

                if (renamingSetId === s.id) {
                  row.innerHTML = `
                    <input type="text" value="${s.name}" class="flex-1 p-1 border rounded text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400" autofocus onblur="finishRenameSet('${s.id}', this.value)" onkeydown="if(event.key==='Enter') finishRenameSet('${s.id}', this.value); if(event.key==='Escape') finishRenameSet('${s.id}', null);">
                    ${editMode ? `
                      <button class="ml-2 p-1 hover:bg-gray-200 rounded-full drag-handle" title="Drag to reorder">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="8" y1="6" x2="16" y2="6"></line>
                          <line x1="8" y1="12" x2="16" y2="12"></line>
                          <line x1="8" y1="18" x2="16" y2="18"></line>
                        </svg>
                      </button>
                    ` : ''}
                  `;
                } else {
                  row.innerHTML = `
                    ${editMode ? `<input type="checkbox" class="mr-3 set-checkbox" data-id="${s.id}" ${selectedIds.has(s.id) ? 'checked' : ''}>` : ''}
                    <div class="flex-1 cursor-pointer" ${editMode ? `onclick="startRenameSet('${s.id}')"` : `onclick="selectedSetlist = '${s.id}'; renderPanelContent();"`}>
                      <div class="font-medium truncate">${s.name}</div>
                    </div>
                    ${editMode ? `
                      <button class="ml-2 p-1 hover:bg-gray-200 rounded-full drag-handle" title="Drag to reorder">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <line x1="8" y1="6" x2="16" y2="6"></line>
                          <line x1="8" y1="12" x2="16" y2="12"></line>
                          <line x1="8" y1="18" x2="16" y2="18"></line>
                        </svg>
                      </button>
                    ` : ''}
                  `;
                }

                list.appendChild(row);
              });
            }

            const addSet = document.createElement('button');
            addSet.textContent = '+';
            addSet.className = 'absolute top-3 right-3 px-2.5 py-1 bg-indigo-600 text-white rounded-full text-sm';
            addSet.onclick = () => document.getElementById('addSetModal').classList.remove('hidden');
            content.appendChild(addSet);

            if (editMode) {
              list.querySelectorAll('.set-checkbox').forEach(chk => {
                chk.onchange = e => {
                  if (e.target.checked) selectedIds.add(e.target.dataset.id);
                  else selectedIds.delete(e.target.dataset.id);
                  renderPanelContent();
                };
              });

              list.addEventListener('dragstart', e => {
                const item = e.target.closest('[draggable]');
                if (item) item.classList.add('dragging');
              });
              list.addEventListener('dragend', e => {
                const item = e.target.closest('[draggable]');
                if (item) item.classList.remove('dragging');
              });
              list.addEventListener('dragover', e => {
                e.preventDefault();
                const dragging = list.querySelector('.dragging');
                const after = [...list.children].find(el => el !== dragging && e.clientY < el.getBoundingClientRect().top + el.getBoundingClientRect().height / 2);
                if (after) list.insertBefore(dragging, after);
                else list.appendChild(dragging);
              });
              list.addEventListener('drop', () => {
                const newOrder = [...list.children].map(el => el.dataset.id).filter(Boolean);
                setlists = newOrder.map(id => setlists.find(s => s.id === id)).filter(Boolean);
                saveData();
                renderPanelContent();
              });
            }
          }
        }
      }

      function startRenameSet(id) {
        renamingSetId = id;
        renderPanelContent();
      }

      function finishRenameSet(id, newName) {
        if (newName !== null && newName.trim()) {
          const set = setlists.find(s => s.id === id);
          if (set) {
            set.name = newName.trim();
            saveData();
          }
        }
        renamingSetId = null;
        renderPanelContent();
      }

      function renderArtistList(container, filter = '') {
        let artists = [...new Set(songs.map(s => s.artist))];
        if (filter.trim()) {
          const lower = filter.toLowerCase();
          artists = artists.filter(a => a.toLowerCase().includes(lower));
        }
        artists.sort((a, b) => a.localeCompare(b));

        container.innerHTML = '';

        artists.forEach(artist => {
          const count = songs.filter(s => s.artist === artist).length;
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between px-4 py-3 hover:bg-indigo-50 border-b cursor-pointer';
          row.innerHTML = `
            <div class="font-medium">${artist}</div>
            <div class="text-sm text-gray-500">${count} song${count !== 1 ? 's' : ''}</div>
          `;
          row.onclick = () => {
            currentArtistFilter = artist;
            renderPanelContent();
          };
          container.appendChild(row);
        });
      }

      function renderSongsList(filter = '', container) {
        container.innerHTML = '';

        let filtered = songs;
        if (currentArtistFilter) {
          filtered = filtered.filter(s => s.artist === currentArtistFilter);
        }

        if (filter.trim()) {
          const lower = filter.toLowerCase();
          filtered = filtered.filter(s => s.title.toLowerCase().includes(lower));
        }

        if (currentArtistFilter) {
          if (!container.parentElement.querySelector('.artist-header')) {
            const header = document.createElement('div');
            header.className = 'artist-header text-2xl font-bold mb-4 px-4';
            header.textContent = currentArtistFilter;
            container.parentElement.insertBefore(header, container);
          }

          if (!container.parentElement.querySelector('.back-btn')) {
            const back = document.createElement('button');
            back.textContent = '← Back to Artists';
            back.className = 'back-btn mb-3 ml-4 text-sm text-indigo-600 hover:underline';
            back.onclick = () => {
              currentArtistFilter = null;
              renderPanelContent();
            };
            container.parentElement.insertBefore(back, container);
          }
        }

        const useAlphabet = currentSort === 'title' && !currentArtistFilter;

        if (useAlphabet) {
          let lastLetter = '';
          filtered.forEach(song => {
            const firstLetter = song.title.charAt(0).toUpperCase();
            if (firstLetter !== lastLetter) {
              const header = document.createElement('div');
              header.className = 'letter-header';
              header.textContent = firstLetter;
              container.appendChild(header);
              lastLetter = firstLetter;
            }
            addSongRow(song, container);
          });
        } else {
          filtered.forEach(song => addSongRow(song, container));
        }
      }

      function addSongRow(song, container) {
        const row = document.createElement('div');
        row.className = 'flex items-center px-4 py-2 hover:bg-indigo-50 border-b text-sm relative';

        let dateLabel = 'No date';
        if (song.dateAdded) {
          const date = new Date(song.dateAdded);
          const today = new Date();
          today.setHours(0,0,0,0);
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          const weekAgo = new Date(today);
          weekAgo.setDate(weekAgo.getDate() - 7);

          if (date.toDateString() === today.toDateString()) dateLabel = 'Today';
          else if (date.toDateString() === yesterday.toDateString()) dateLabel = 'Yesterday';
          else if (date >= weekAgo && date < today) dateLabel = 'This week';
          else dateLabel = date.toLocaleDateString('default', { month: 'short', year: 'numeric' });
        }

        const extra = `<div class="text-xs text-gray-500 ml-auto">${dateLabel}</div>`;

        row.innerHTML = `
          ${editMode ? `<input type="checkbox" class="mr-3" ${selectedIds.has(song.id)?'checked':''}>` : ''}
          <div class="flex-1 min-w-0">
            <div class="font-medium truncate">${song.title}</div>
            ${currentArtistFilter ? '' : `<div class="text-xs text-gray-600 truncate">${song.artist}</div>`}
          </div>
          ${extra}
          ${editMode ? `
            <button class="ml-2 p-1 hover:bg-gray-200 rounded-full edit-song-btn" data-id="${song.id}" title="Edit song">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </button>
          ` : ''}
        `;

        if (editMode) {
          row.querySelector('input').onchange = e => {
            if (e.target.checked) selectedIds.add(song.id);
            else selectedIds.delete(song.id);
            renderPanelContent();
          };
          row.querySelector('.edit-song-btn')?.addEventListener('click', e => {
            e.stopPropagation();
            editSong(song.id);
          });
        } else {
          row.onclick = () => showSong(song);
        }

        container.appendChild(row);
      }

      function editSong(id) {
        const song = songs.find(s => s.id === id);
        if (!song) return;
        currentEditSongId = id;
        document.getElementById('editTitle').value = song.title;
        document.getElementById('editArtist').value = song.artist;
        document.getElementById('editLyrics').value = song.lyricsWithChords || '';
        document.getElementById('editSongModal').classList.remove('hidden');
      }

      function saveEditedSong() {
        const title = document.getElementById('editTitle').value.trim();
        const artist = document.getElementById('editArtist').value.trim();
        const lyrics = document.getElementById('editLyrics').value.trim();
        if (title && artist && lyrics && currentEditSongId) {
          const song = songs.find(s => s.id === currentEditSongId);
          if (song) {
            song.title = title;
            song.artist = artist;
            song.lyricsWithChords = lyrics;
            saveData();
            renderPanelContent();
            document.getElementById('editSongModal').classList.add('hidden');
          }
        }
      }

      function showDeleteConfirm() {
        document.getElementById('confirmDeleteModal').classList.remove('hidden');
      }

      function confirmDelete() {
        document.getElementById('confirmDeleteModal').classList.add('hidden');
        if (currentView === 'songs') {
          songs = songs.filter(s => !selectedIds.has(s.id));
          setlists.forEach(s => s.songIds = s.songIds.filter(id => !selectedIds.has(id)));
        } else if (currentView === 'sets') {
          setlists = setlists.filter(s => !selectedIds.has(s.id));
        }
        saveData();
        selectedIds.clear();
        editMode = false;
        renderPanelContent();
      }

      function showAddToSetModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white p-6 rounded-lg w-11/12 max-w-sm max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4">Add to Set</h3>
            ${setlists.length === 0 ? '<p class="text-center text-gray-500 mb-4">No sets yet. Create one first.</p>' : ''}
            ${setlists.map(s => `
              <button class="w-full text-left px-4 py-3 hover:bg-indigo-50 border-b last:border-b-0" onclick="addSelectedToSet('${s.id}'); this.closest('.fixed').remove()">
                ${s.name} (${s.songIds.length} songs)
              </button>
            `).join('')}
            <button class="mt-4 w-full py-2 bg-gray-300 rounded text-sm" onclick="this.closest('.fixed').remove()">Cancel</button>
          </div>
        `;
        document.body.appendChild(modal);
      }

      function addSelectedToSet(setId) {
        const set = setlists.find(s => s.id === setId);
        if (!set) return;

        selectedIds.forEach(id => {
          if (!set.songIds.includes(id)) {
            set.songIds.push(id);
          }
        });

        saveData();
        renderPanelContent();
      }

      function saveNewSong() {
        const title = document.getElementById('addTitle').value.trim();
        const artist = document.getElementById('addArtist').value.trim();
        const lyrics = document.getElementById('addLyrics').value.trim();
        if (title && artist && lyrics) {
          songs.push({
            id: Date.now().toString(),
            title, artist, lyricsWithChords: lyrics,
            dateAdded: new Date().toISOString()
          });
          saveData();
          renderPanelContent();
          document.getElementById('addSongModal').classList.add('hidden');
        }
      }

      function saveNewSet() {
        const name = document.getElementById('addSetName').value.trim();
        if (name) {
          setlists.push({ id: Date.now().toString(), name, songIds: [] });
          saveData();
          renderPanelContent();
          document.getElementById('addSetModal').classList.add('hidden');
        }
      }

      if (songs.length === 0) {
        songs = [
          { id: '1', title: 'Wonderwall', artist: 'Oasis', lyricsWithChords: '[Em] [G] [D] [A7sus4]\nToday is gonna be the day...', dateAdded: new Date().toISOString() },
          { id: '2', title: 'Horse With No Name', artist: 'America', lyricsWithChords: '[Em] [D6/9] ...\nOn the first part...', dateAdded: new Date().toISOString() },
          { id: '3', title: 'Hallelujah', artist: 'Leonard Cohen', lyricsWithChords: '[C] [Am] ...\nI\'ve heard there was...', dateAdded: new Date().toISOString() }
        ];
        saveData();
      }

      renderPanelContent();
    </script>
</body>
</html>
